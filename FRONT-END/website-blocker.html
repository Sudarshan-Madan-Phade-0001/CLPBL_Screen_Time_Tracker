<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Website Blocker</title>
  <link rel="stylesheet" href="website-blocker.css">
  <style>
    .timer-overlay {
      position: fixed;
      top: 10px;
      right: 10px;
      background-color: #077b32;
      color: white;
      padding: 10px 15px;
      border-radius: 8px;
      font-family: Arial, sans-serif;
      z-index: 9999;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .timer-display {
      font-size: 18px;
      font-weight: bold;
      margin: 5px 0;
    }

    .progress-bar {
      width: 100%;
      height: 5px;
      background-color: rgba(255, 255, 255, 0.3);
      border-radius: 3px;
      margin-top: 5px;
      overflow: hidden;
    }

    .progress {
      height: 100%;
      background-color: white;
      width: 100%;
      transition: width 1s linear;
    }

    .time-up-message {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.9);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      color: white;
      text-align: center;
    }

    .time-up-message h2 {
      font-size: 2rem;
      margin-bottom: 1rem;
      color: #077b32;
    }

    .time-up-message p {
      font-size: 1.2rem;
      margin-bottom: 2rem;
    }

    .time-up-message button {
      background-color: #077b32;
      color: white;
      border: none;
      padding: 1rem 2rem;
      font-size: 1.2rem;
      border-radius: 5px;
      cursor: pointer;
    }

    .error-message {
      color: #ff3b3b;
      margin-top: 10px;
      text-align: center;
      font-weight: bold;
    }
  </style>
</head>

<body>
  <header>
    <nav>
      <div class="logo">Screen <span>Time Tracker</span></div>
      <div class="nav-links">
        <a href="home.html">Home</a>
        <a href="email-viewer.html">Login Details</a>
        <a href="about.html">About</a>
      </div>
    </nav>
  </header>

  <div class="container" id="main-container">
    <div class="hero">
      <h1>Website <span>Time Limiter</span></h1>
      <p>Take control of your digital habits by setting daily time limits for distracting websites. Use your time
        intentionally and boost your productivity.</p>
    </div>

    <div class="blocker-form">
      <h2 class="form-title">Add Website Limit</h2>
      <form id="website-form">
        <div class="form-row">
          <div class="form-group website-input">
            <label for="website-url">Website URL</label>
            <input type="text" id="website-url" placeholder="e.g., instagram.com" required>
          </div>
          <div class="form-group time-input">
            <label for="time-limit">Daily Limit (minutes)</label>
            <input type="number" id="time-limit" min="1" max="1440" value="20" required>
          </div>
        </div>
        <button type="submit">Add Website</button>
        <div id="error-message" class="error-message"></div>
      </form>
    </div>

    <div class="website-list">
      <h2 class="list-title">Your Limited Websites</h2>
      <div id="websites-container" class="websites-container">
        <!-- Website cards will be added here dynamically -->
      </div>
    </div>

    <div class="how-it-works">
      <h2 class="form-title">How It Works</h2>
      <ol class="steps">
        <li>Add websites you want to limit your time on</li>
        <li>Set a daily time limit for each website (default: 20 minutes)</li>
        <li>When you want to use a website, click "Use Now" and specify how many minutes you want to use</li>
        <li>After your time is up, you'll be prompted to start a focus session</li>
        <li>All time limits reset automatically at midnight</li>
      </ol>
      <div class="note">
        <strong>Note:</strong> This feature helps you balance leisure and productivity. After each social media session,
        you'll be guided to focus on something productive.
      </div>
    </div>
  </div>

  <script src="website-blocker.js"></script>
  <script src="export_data.js"></script>
  <script>
    // Initialize the website blocker functionality
    document.addEventListener('DOMContentLoaded', () => {
      // Load existing website data
      renderWebsites();

      // Handle form submission
      document.getElementById('website-form').addEventListener('submit', (e) => {
        e.preventDefault();

        const urlInput = document.getElementById('website-url');
        const timeLimitInput = document.getElementById('time-limit');
        const errorMessage = document.getElementById('error-message');

        let url = urlInput.value.trim();
        const timeLimit = parseInt(timeLimitInput.value);

        // Clear previous error message
        errorMessage.textContent = '';

        // Basic validation
        if (!url || isNaN(timeLimit) || timeLimit <= 0) {
          errorMessage.textContent = 'Please enter a valid website URL and time limit.';
          return;
        }

        // Add http:// if not present and not already starting with http/https
        if (!url.startsWith('http://') && !url.startsWith('https://')) {
          url = 'https://' + url;
        }

        // Check if website already exists
        let hostname;
        try {
          hostname = new URL(url).hostname;
        } catch (e) {
          hostname = url;
        }

        const existingWebsite = websiteTracker.findWebsiteByUrl(hostname);
        if (existingWebsite) {
          errorMessage.textContent = `${hostname} already has a daily limit of ${existingWebsite.timeLimit} minutes. You can use it again tomorrow.`;
          return;
        }

        // Add to websites list using the tracker
        const displayUrl = websiteTracker.addWebsite(url, timeLimit);

        // Update UI
        renderWebsites();

        // Reset form
        urlInput.value = '';
        timeLimitInput.value = '20';

        alert(`${displayUrl} has been added with a daily limit of ${timeLimit} minutes.`);
      });
    });

    // Render website cards
    function renderWebsites() {
      const websites = websiteTracker.getAllWebsites();
      const container = document.getElementById('websites-container');
      container.innerHTML = '';

      if (websites.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <p>No websites added yet. Add your first website above!</p>
          </div>
        `;
        return;
      }

      websites.forEach((website, index) => {
        const timeRemaining = websiteTracker.getTimeRemaining(website.url);
        const percentRemaining = (timeRemaining / website.timeLimit) * 100;

        const websiteCard = document.createElement('div');
        websiteCard.className = 'website-card';
        websiteCard.innerHTML = `
          <div class="time-display">
            <svg width="100" height="100" viewBox="0 0 100 100">
              <circle cx="50" cy="50" r="40" fill="none" stroke="#1a2e4c" stroke-width="10" />
              <circle class="progress-ring" cx="50" cy="50" r="40" fill="none" 
                stroke="${percentRemaining > 25 ? '#077b32' : '#ff3b3b'}" 
                stroke-width="10" 
                stroke-dasharray="251.2 251.2" 
                stroke-dashoffset="0" />
            </svg>
            <div class="time-remaining">
              <span class="time-value">${formatTime(timeRemaining)}</span>
              <span class="time-label">remaining</span>
            </div>
          </div>
          
          <div class="website-info">
            <h3 class="website-name">${website.url}</h3>
            <p class="website-limit">
              Daily limit: ${formatTime(website.timeLimit)}
            </p>
            <div class="card-actions">
              <button class="use-btn" data-index="${index}" ${timeRemaining <= 0 ? 'disabled' : ''}>
                Use Now
              </button>
              ${website.timeUsed > 0 ?
            `<button class="locked-btn" disabled>Cannot Remove (Used Today)</button>` :
            `<button class="delete-btn" data-index="${index}">Remove</button>`
          }
            </div>
          </div>
        `;

        container.appendChild(websiteCard);

        // Update the progress ring
        const progressRing = websiteCard.querySelector('.progress-ring');
        updateProgressRing(progressRing, percentRemaining);
      });

      // Add event listeners to buttons
      document.querySelectorAll('.use-btn').forEach(btn => {
        btn.addEventListener('click', handleUseWebsite);
      });

      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', handleDeleteWebsite);
      });
    }

    // Format time (minutes) to display
    function formatTime(minutes) {
      const hours = Math.floor(minutes / 60);
      const mins = minutes % 60;
      return hours > 0 ? `${hours}h ${mins}m` : `${mins}m`;
    }

    // Update progress ring
    function updateProgressRing(element, percent) {
      const radius = 40;
      const circumference = 2 * Math.PI * radius;
      const offset = circumference - (percent / 100) * circumference;
      element.style.strokeDasharray = `${circumference} ${circumference}`;
      element.style.strokeDashoffset = offset;
    }

    // Handle using a website
    function handleUseWebsite(e) {
      const index = parseInt(e.target.dataset.index);
      const websites = websiteTracker.getAllWebsites();

      if (index >= 0 && index < websites.length) {
        const website = websites[index];
        const timeRemaining = websiteTracker.getTimeRemaining(website.url);

        if (timeRemaining <= 0) {
          alert(`You've reached your daily limit for ${website.url}. Try again tomorrow!`);
          return;
        }

        // Ask user how many minutes they want to use
        const useTime = prompt(`How many minutes do you want to use ${website.url}? (Available: ${timeRemaining} minutes)`, "1");
        const minutes = parseInt(useTime);

        if (isNaN(minutes) || minutes <= 0) {
          alert('Please enter a valid number of minutes.');
          return;
        }

        if (minutes > timeRemaining) {
          alert(`You only have ${timeRemaining} minutes remaining today.`);
          return;
        }

        // Start a website session
        const result = websiteTracker.startWebsiteSession(website.url, minutes);

        if (result.success) {
          // Create a timer overlay in our app
          const timerOverlay = document.createElement('div');
          timerOverlay.className = 'timer-overlay';
          timerOverlay.innerHTML = `
            <div>Using ${website.url}</div>
            <div class="timer-display" id="timer-display">${minutes}:00</div>
            <div class="progress-bar">
              <div class="progress" id="timer-progress"></div>
            </div>
          `;
          document.body.appendChild(timerOverlay);

          // Open the website in a new tab
          const socialWindow = window.open(result.url, '_blank');

          // Set up the countdown in our app
          let timeLeft = minutes * 60;
          const initialTime = timeLeft;
          const timerDisplay = document.getElementById('timer-display');
          const timerProgress = document.getElementById('timer-progress');

          const countdownTimer = setInterval(() => {
            timeLeft--;

            // Update timer display
            const mins = Math.floor(timeLeft / 60);
            const secs = timeLeft % 60;
            timerDisplay.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;

            // Update progress bar
            const percentLeft = (timeLeft / initialTime) * 100;
            timerProgress.style.width = `${percentLeft}%`;

            if (timeLeft <= 0) {
              clearInterval(countdownTimer);

              // End the session
              websiteTracker.endWebsiteSession(minutes);

              // Remove the timer overlay
              document.body.removeChild(timerOverlay);

              // Show time's up message
              const timeUpMessage = document.createElement('div');
              timeUpMessage.className = 'time-up-message';
              timeUpMessage.innerHTML = `
                <h2>Time's Up!</h2>
                <p>Your ${minutes}-minute session on ${website.url} has ended.</p>
                <p>Click the button below to start your focus session.</p>
                <button id="focus-button">Start Focus Session</button>
              `;
              document.body.appendChild(timeUpMessage);

              // Add event listener to the focus button
              document.getElementById('focus-button').addEventListener('click', () => {
                window.location.href = 'focus-timer.html';
              });

              // Try to communicate with the extension to block the website
              try {
                // The extension ID will be different for each installation
                // Users need to update this with their actual extension ID
                const EXTENSION_ID = "cifjlfjeohnbkbacmbghhalchfaieckn";

                // Send message to extension
                chrome.runtime.sendMessage(EXTENSION_ID, {
                  action: "timeUp",
                  website: website.url
                }, function (response) {
                  if (chrome.runtime.lastError) {
                    console.log("Extension communication error:", chrome.runtime.lastError.message);
                  } else if (response && response.success) {
                    console.log("Notification sent to social media site");
                  }
                });

                // Also update the website limits in the extension
                chrome.runtime.sendMessage(EXTENSION_ID, {
                  action: "updateLimits",
                  limits: websiteTracker.getAllWebsites().reduce((acc, site) => {
                    acc[site.url] = {
                      timeLimit: site.timeLimit * 60 * 1000, // Convert to milliseconds
                      timeUsed: site.timeUsed * 60 * 1000, // Convert to milliseconds
                      lastReset: site.lastReset
                    };
                    return acc;
                  }, {})
                }, function (response) {
                  if (chrome.runtime.lastError) {
                    console.log("Extension communication error:", chrome.runtime.lastError.message);
                  } else if (response && response.success) {
                    console.log("Website limits updated in extension");
                  }
                });
              } catch (e) {
                console.log("Extension not available or not installed:", e);
              }

              // Update UI
              renderWebsites();
            }
          }, 1000);
        } else {
          alert(result.message);
        }
      }
    }

    // Handle deleting a website
    function handleDeleteWebsite(e) {
      const index = parseInt(e.target.dataset.index);
      const websites = websiteTracker.getAllWebsites();

      if (index >= 0 && index < websites.length) {
        const website = websites[index];

        // Check if the website has been used today
        if (website.timeUsed > 0) {
          alert(`You cannot remove ${website.url} because you've already used it today. It will be available for removal tomorrow.`);
          return;
        }

        if (confirm(`Are you sure you want to remove ${website.url}?`)) {
          const success = websiteTracker.removeWebsite(index);
          if (success) {
            renderWebsites();
          } else {
            alert(`Could not remove ${website.url}. It may have been used today.`);
          }
        }
      }
    }
  </script>
</body>

</html>